
//num_leap_days_from_days
	//return ((d/146097.0)*97.0) + (((d%146097.0)/36524.25)*24.0) + ((d%36524.25)/1460.97) + 1.0;
	//return (days/1461) - ((days/146097)*3) - ((days%146097)/36525) + 5;
	


	288, 289, 290, 291, 292, 293, 294, 295, 296, 297, 298, 299, //10-26
	300, 301, 302, 303, 304, 305, 306, 307, 308, 309, 310, 311, //11-7
	312, 313, 314, 315, 316, 317, 318, 319, 320, 321, 322, 323, //11-19
	324, 325, 326, 327, 328, 329, 330, 331, 332, 333, 334, 335, //12-1
	336, 337, 338, 339, 340, 341, 342, 343, 344, 345, 346, 347,
	348, 349, 350, 351, 352, 353, 354, 355, 356, 357, 358, 359, //12-25
	360, 361, 362, 363, 364, 365,   0,   1,   2,   3,   4,   5,
	  6,   7,   8,   9,  10,  11,  12,  13,  14,  15,  16,  17, //1-18
	 18,  19,  20,  21,  22,  23,  24,  25,  26,  27,  28,  29,
	 30,  31,  32,  33,  34,  35,  36,  37,  38,  39,  40,  41, //2-11
	 42,  43,  44,  45,  46,  47,  48,  49,  50,  51,  52,  53,
	 54,  55,  56,  57,  58,  59,  60,  61,  62,  63,  64,  65, //3-6
	 66,  67,  68,  69,  70,  71,  72,  73,  74,  75,  76,  77,
	 78,  79,  80,  81,  82,  83,  84,  85,  86,  87,  88,  89, //3-30
	 90,  91,  92,  93,  94,  95,  96,  97,  98,  99, 100, 101,
	102, 103, 104, 105, 106, 107, 108, 109, 110, 111, 112, 113, //4-17
	114, 115, 116, 117, 118, 119, 120, 121, 122, 123, 124, 125,
	126, 127, 128, 129, 130, 131, 132, 133, 134, 135, 136, 137, //5-11
	138, 139, 140, 141, 142, 143, 144, 145, 146, 147, 148, 149,
	150, 151, 152, 153, 154, 155, 156, 157, 158, 159, 160, 161, //6-4
	162, 163, 164, 165, 166, 167, 168, 169, 170, 171, 172, 173,
	174, 175, 176, 177, 178, 179, 180, 181, 182, 183, 184, 185, //6-28
	186, 187, 188, 189, 190, 191, 192, 193, 194, 195, 196, 197,
	198, 199, 200, 201, 202, 203, 204, 205, 206, 207, 208, 209, //7-22
	210, 211, 212, 213, 214, 215, 216, 217, 218, 219, 220, 221,
	222, 223, 224, 225, 226, 227, 228, 229, 230, 231, 232, 233, //8-15
	234, 235, 236, 237, 238, 239, 240, 241, 242, 243, 244, 245,
	246, 247, 248, 249, 250, 251, 252, 253, 254, 255, 256, 257, //9-14
	258, 259, 260, 261, 262, 263, 264, 265, 266, 267, 268, 269,
	270, 271, 272, 273, 274, 275, 276, 277, 278, 279, 280, 281, //10-8
	282, 283, 284, 285, 286, 287



	
	{10,15}, {10,16}, {10,17}, {10,18}, {10,19}, {10,20}, /* 5 */
	{10,21}, {10,22}, {10,23}, {10,24}, {10,25}, {10,26},
	{10,27}, {10,28}, {10,29}, {10,30}, {10,31}, {11, 1},
	{11, 2}, {11, 3}, {11, 4}, {11, 5}, {11, 6}, {11, 7},
	{11, 8}, {11, 9}, {11,10}, {11,11}, {11,12}, {11,13},
	{11,14}, {11,15}, {11,16}, {11,17}, {11,18}, {11,19}, /* 35 */
	{11,20}, {11,21}, {11,22}, {11,23}, {11,24}, {11,25},
	{11,26}, {11,27}, {11,28}, {11,29}, {11,30}, {12, 1},
	{12, 2}, {12, 3}, {12, 4}, {12, 5}, {12, 6}, {12, 7},
	{12, 8}, {12, 9}, {12,10}, {12,11}, {12,12}, {12,13},
	{12,14}, {12,15}, {12,16}, {12,17}, {12,18}, {12,19}, /* 65 */
	{12,20}, {12,21}, {12,22}, {12,23}, {12,24}, {12,25},
	{12,26}, {12,27}, {12,28}, {12,29}, {12,30}, {12,31},
	{ 1, 1}, { 1, 2}, { 1, 3}, { 1, 4}, { 1, 5}, { 1, 6},
	{ 1, 7}, { 1, 8}, { 1, 9}, { 1,10}, { 1,11}, { 1,12},
	{ 1,13}, { 1,14}, { 1,15}, { 1,16}, { 1,17}, { 1,18}, /* 95 */
	{ 1,19}, { 1,20}, { 1,21}, { 1,22}, { 1,23}, { 1,24},
	{ 1,25}, { 1,26}, { 1,27}, { 1,28}, { 1,29}, { 1,30},
	{ 1,31}, { 2, 1}, { 2, 2}, { 2, 3}, { 2, 4}, { 2, 5},
	{ 2, 6}, { 2, 7}, { 2, 8}, { 2, 9}, { 2,10}, { 2,11},
	{ 2,12}, { 2,13}, { 2,14}, { 2,15}, { 2,16}, { 2,17}, /* 125 */
	{ 2,18}, { 2,19}, { 2,20}, { 2,21}, { 2,22}, { 2,23},
	{ 2,24}, { 2,25}, { 2,26}, { 2,27}, { 2,28}, { 2,29},
	{ 3, 1}, { 3, 2}, { 3, 3}, { 3, 4}, { 3, 5}, { 3, 6},
	{ 3, 7}, { 3, 8}, { 3, 9}, { 3,10}, { 3,11}, { 3,12},
	{ 3,13}, { 3,14}, { 3,15}, { 3,16}, { 3,17}, { 3,18}, /* 155 */
	{ 3,19}, { 3,20}, { 3,21}, { 3,22}, { 3,23}, { 3,24},
	{ 3,25}, { 3,26}, { 3,27}, { 3,28}, { 3,29}, { 3,30},
	{ 3,31}, { 4, 1}, { 4, 2}, { 4, 3}, { 4, 4}, { 4, 5},
	{ 4, 6}, { 4, 7}, { 4, 8}, { 4, 9}, { 4,10}, { 4,11},
	{ 4,12}, { 4,13}, { 4,14}, { 4,15}, { 4,16}, { 4,17}, /* 185 */
	{ 4,18}, { 4,19}, { 4,20}, { 4,21}, { 4,22}, { 4,23},
	{ 4,24}, { 4,25}, { 4,26}, { 4,27}, { 4,28}, { 4,29},
	{ 4,30}, { 5, 1}, { 5, 2}, { 5, 3}, { 5, 4}, { 5, 5},
	{ 5, 6}, { 5, 7}, { 5, 8}, { 5, 9}, { 5,10}, { 5,11},
	{ 5,12}, { 5,13}, { 5,14}, { 5,15}, { 5,16}, { 5,17}, /* 215 */
	{ 5,18}, { 5,19}, { 5,20}, { 5,21}, { 5,22}, { 5,23},
	{ 5,24}, { 5,25}, { 5,26}, { 5,27}, { 5,28}, { 5,29},
	{ 5,30}, { 5,31}, { 6, 1}, { 6, 2}, { 6, 3}, { 6, 4},
	{ 6, 5}, { 6, 6}, { 6, 7}, { 6, 8}, { 6, 9}, { 6,10},
	{ 6,11}, { 6,12}, { 6,13}, { 6,14}, { 6,15}, { 6,16}, /* 245 */
	{ 6,17}, { 6,18}, { 6,19}, { 6,20}, { 6,21}, { 6,22},
	{ 6,23}, { 6,24}, { 6,25}, { 6,26}, { 6,27}, { 6,28},
	{ 6,29}, { 6,30}, { 7, 1}, { 7, 2}, { 7, 3}, { 7, 4},
	{ 7, 5}, { 7, 6}, { 7, 7}, { 7, 8}, { 7, 9}, { 7,10},
	{ 7,11}, { 7,12}, { 7,13}, { 7,14}, { 7,15}, { 7,16}, /* 275 */
	{ 7,17}, { 7,18}, { 7,19}, { 7,20}, { 7,21}, { 7,22},
	{ 7,23}, { 7,24}, { 7,25}, { 7,26}, { 7,27}, { 7,28},
	{ 7,29}, { 7,30}, { 7,31}, { 8, 1}, { 8, 2}, { 8, 3},
	{ 8, 4}, { 8, 5}, { 8, 6}, { 8, 7}, { 8, 8}, { 8, 9},
	{ 8,10}, { 8,11}, { 8,12}, { 8,13}, { 8,14}, { 8,15}, /* 305 */
	{ 8,16}, { 8,17}, { 8,18}, { 8,19}, { 8,20}, { 8,21},
	{ 8,22}, { 8,23}, { 8,24}, { 8,25}, { 8,26}, { 8,27},
	{ 8,28}, { 8,29}, { 8,30}, { 8,31}, { 9, 1}, { 9, 2},
	{ 9, 3}, { 9, 4}, { 9, 5}, { 9, 6}, { 9, 7}, { 9, 8},
	{ 9, 9}, { 9,10}, { 9,11}, { 9,12}, { 9,13}, { 9,14}, /* 335 */
	{ 9,15}, { 9,16}, { 9,17}, { 9,18}, { 9,19}, { 9,20},
	{ 9,21}, { 9,22}, { 9,23}, { 9,24}, { 9,25}, { 9,26},
	{ 9,27}, { 9,28}, { 9,29}, { 9,30}, {10, 1}, {10, 2},
	{10, 3}, {10, 4}, {10, 5}, {10, 6}, {10, 7}, {10, 8},
	{10, 9}, {10,10}, {10,11}, {10,12}, {10,13}, {10,14} /* 365 */

	{ 1, 1}, { 1, 2}, { 1, 3}, { 1, 4}, { 1, 5}, { 1, 6}, /* 5 */
	{ 1, 7}, { 1, 8}, { 1, 9}, { 1,10}, { 1,11}, { 1,12},
	{ 1,13}, { 1,14}, { 1,15}, { 1,16}, { 1,17}, { 1,18},
	{ 1,19}, { 1,20}, { 1,21}, { 1,22}, { 1,23}, { 1,24},
	{ 1,25}, { 1,26}, { 1,27}, { 1,28}, { 1,29}, { 1,30},
	{ 1,31}, { 2, 1}, { 2, 2}, { 2, 3}, { 2, 4}, { 2, 5}, /* 35 */
	{ 2, 6}, { 2, 7}, { 2, 8}, { 2, 9}, { 2,10}, { 2,11},
	{ 2,12}, { 2,13}, { 2,14}, { 2,15}, { 2,16}, { 2,17},
	{ 2,18}, { 2,19}, { 2,20}, { 2,21}, { 2,22}, { 2,23},
	{ 2,24}, { 2,25}, { 2,26}, { 2,27}, { 2,28}, { 2,29},
	{ 3, 1}, { 3, 2}, { 3, 3}, { 3, 4}, { 3, 5}, { 3, 6}, /* 65 */
	{ 3, 7}, { 3, 8}, { 3, 9}, { 3,10}, { 3,11}, { 3,12},
	{ 3,13}, { 3,14}, { 3,15}, { 3,16}, { 3,17}, { 3,18},
	{ 3,19}, { 3,20}, { 3,21}, { 3,22}, { 3,23}, { 3,24},
	{ 3,25}, { 3,26}, { 3,27}, { 3,28}, { 3,29}, { 3,30},
	{ 3,31}, { 4, 1}, { 4, 2}, { 4, 3}, { 4, 4}, { 4, 5}, /* 95 */
	{ 4, 6}, { 4, 7}, { 4, 8}, { 4, 9}, { 4,10}, { 4,11},
	{ 4,12}, { 4,13}, { 4,14}, { 4,15}, { 4,16}, { 4,17},
	{ 4,18}, { 4,19}, { 4,20}, { 4,21}, { 4,22}, { 4,23},
	{ 4,24}, { 4,25}, { 4,26}, { 4,27}, { 4,28}, { 4,29},
	{ 4,30}, { 5, 1}, { 5, 2}, { 5, 3}, { 5, 4}, { 5, 5}, /* 125 */
	{ 5, 6}, { 5, 7}, { 5, 8}, { 5, 9}, { 5,10}, { 5,11},
	{ 5,12}, { 5,13}, { 5,14}, { 5,15}, { 5,16}, { 5,17},
	{ 5,18}, { 5,19}, { 5,20}, { 5,21}, { 5,22}, { 5,23},
	{ 5,24}, { 5,25}, { 5,26}, { 5,27}, { 5,28}, { 5,29},
	{ 5,30}, { 5,31}, { 6, 1}, { 6, 2}, { 6, 3}, { 6, 4}, /* 155 */
	{ 6, 5}, { 6, 6}, { 6, 7}, { 6, 8}, { 6, 9}, { 6,10},
	{ 6,11}, { 6,12}, { 6,13}, { 6,14}, { 6,15}, { 6,16},
	{ 6,17}, { 6,18}, { 6,19}, { 6,20}, { 6,21}, { 6,22},
	{ 6,23}, { 6,24}, { 6,25}, { 6,26}, { 6,27}, { 6,28},
	{ 6,29}, { 6,30}, { 7, 1}, { 7, 2}, { 7, 3}, { 7, 4}, /* 185 */
	{ 7, 5}, { 7, 6}, { 7, 7}, { 7, 8}, { 7, 9}, { 7,10},
	{ 7,11}, { 7,12}, { 7,13}, { 7,14}, { 7,15}, { 7,16},
	{ 7,17}, { 7,18}, { 7,19}, { 7,20}, { 7,21}, { 7,22},
	{ 7,23}, { 7,24}, { 7,25}, { 7,26}, { 7,27}, { 7,28},
	{ 7,29}, { 7,30}, { 7,31}, { 8, 1}, { 8, 2}, { 8, 3}, /* 215 */
	{ 8, 4}, { 8, 5}, { 8, 6}, { 8, 7}, { 8, 8}, { 8, 9},
	{ 8,10}, { 8,11}, { 8,12}, { 8,13}, { 8,14}, { 8,15},
	{ 8,16}, { 8,17}, { 8,18}, { 8,19}, { 8,20}, { 8,21},
	{ 8,22}, { 8,23}, { 8,24}, { 8,25}, { 8,26}, { 8,27},
	{ 8,28}, { 8,29}, { 8,30}, { 8,31}, { 9, 1}, { 9, 2}, /* 245 */
	{ 9, 3}, { 9, 4}, { 9, 5}, { 9, 6}, { 9, 7}, { 9, 8},
	{ 9, 9}, { 9,10}, { 9,11}, { 9,12}, { 9,13}, { 9,14},
	{ 9,15}, { 9,16}, { 9,17}, { 9,18}, { 9,19}, { 9,20},
	{ 9,21}, { 9,22}, { 9,23}, { 9,24}, { 9,25}, { 9,26},
	{ 9,27}, { 9,28}, { 9,29}, { 9,30}, {10, 1}, {10, 2}, /* 275 */
	{10, 3}, {10, 4}, {10, 5}, {10, 6}, {10, 7}, {10, 8},
	{10, 9}, {10,10}, {10,11}, {10,12}, {10,13}, {10,14},
	{10,15}, {10,16}, {10,17}, {10,18}, {10,19}, {10,20},
	{10,21}, {10,22}, {10,23}, {10,24}, {10,25}, {10,26},
	{10,27}, {10,28}, {10,29}, {10,30}, {10,31}, {11, 1}, /* 305 */
	{11, 2}, {11, 3}, {11, 4}, {11, 5}, {11, 6}, {11, 7},
	{11, 8}, {11, 9}, {11,10}, {11,11}, {11,12}, {11,13},
	{11,14}, {11,15}, {11,16}, {11,17}, {11,18}, {11,19},
	{11,20}, {11,21}, {11,22}, {11,23}, {11,24}, {11,25},
	{11,26}, {11,27}, {11,28}, {11,29}, {11,30}, {12, 1}, /* 335 */
	{12, 2}, {12, 3}, {12, 4}, {12, 5}, {12, 6}, {12, 7},
	{12, 8}, {12, 9}, {12,10}, {12,11}, {12,12}, {12,13},
	{12,14}, {12,15}, {12,16}, {12,17}, {12,18}, {12,19},
	{12,20}, {12,21}, {12,22}, {12,23}, {12,24}, {12,25},
	{12,26}, {12,27}, {12,28}, {12,29}, {12,30}, {12,31}, /* 365 */


int unixtime_to_systime_ms(__time64_t timestamp, apx_datetime *f)
{
	__int64 n;
	__int64 days;
	short val;

	char dow[] = { 3, 4, 5, 6, 0, 1, 2 }; //unix epoch is on a Thursday so we must normalize the weekday

	f->ms = timestamp % MS_PER_SECOND;

	n = timestamp / MS_PER_SECOND; //seconds since epoch
	f->sec = n % SEC_PER_MINUTE;

	n /= SEC_PER_MINUTE; //minutes since epoch
	f->min = n % MIN_PER_HOUR;

	n /= MIN_PER_HOUR; //hours since epoch
	f->hour = n % HOUR_PER_DAY;

	n /= HOUR_PER_DAY; //days since epoch
	days = (n % DAYS_PER_YEAR) - (n / 1460) + 1;

	//f->dow = day_of_week(n, dow);

	n /= DAYS_PER_YEAR; //years since epoch
	val = 1970 + (short)n;
	f->year = (WORD)val;

	val = get_date_from_days((int)days, val);
	if (!val) return 0;
	f->month = (val >> 8) + 1; //windows systemtime starts at 1
	f->day = 0x1f & val;

	return 1;
}

BOOL systime_to_unixtime_ms(SYSTEMTIME *systime, __time64_t *timestamp)
{
	__time64_t ts = 0;
	short days;

	ts += (systime->wYear - 1970) * MS_PER_YEAR;
	days = num_year_days(systime->wMonth-1, systime->wDay, systime->wYear);
	ts += days * MS_PER_DAY;
	ts += systime->wHour * MS_PER_HOUR;
	ts += systime->wMinute * MS_PER_MINUTE;
	ts += systime->wSecond * MS_PER_SECOND;
	ts += systime->wMilliseconds;
	*timestamp = ts;
	
	return TRUE;
}

int test_time()
{
	__time64_t ts = 1600303652534;

	SYSTEMTIME st;
	st.wYear = 2020;
	st.wMonth = 9;
	st.wDayOfWeek = 3;
	st.wDay = 17;
	st.wHour = 0;
	st.wMinute = 47;
	st.wSecond = 32;
	st.wMilliseconds = 0;
	return 1;
}

#define get_value(dt, mask, off) ((dt >> off) & mask)
#define set_value(cal, val, mask, off) (dt |= (((unsigned long long)val & mask) << off))

#define get_ms(dt)    get_value(dt, 0x3ff, 0)
#define get_sec(dt)   get_value(dt, 0x3f, 10)
#define get_min(dt)   get_value(dt, 0x3f, 16)
#define get_day(dt)   get_value(dt, 0x1f, 22)
#define get_hour(dt)  get_value(dt, 0x1f, 27)
#define get_year(dt)  get_value(dt, 0x1fff, 32)
#define get_dow(dt)   get_value(dt, 0x7, 45)
#define get_month(dt) get_value(dt, 0xf, 48)
#define get_tz(dt)    get_value(dt, 0x7f, 52)
#define get_cal(dt)   get_value(dt, 0x7, 59)
#define get_ver(dt)   get_value(dt, 0x3, 62)

#define set_ms(dt, ms)       set_value(dt, ms, 0x3ff, 0)
#define set_sec(dt, sec)     set_value(dt, sec, 0x3f, 10)
#define set_min(dt, min)     set_value(dt, min, 0x3f, 16)
#define set_day(dt, day)     set_value(dt, day, 0x1f, 22)
#define set_hour(dt, hour)   set_value(dt, hour, 0x1f, 27)
#define set_year(dt, year)   set_value(dt, year, 0x1fff, 32)
#define set_dow(dt, dow)     set_value(dt, dow, 0x7, 45)
#define set_month(dt, month) set_value(dt, month, 0xf, 48)
#define set_tz(dt, tz)       set_value(dt, tz, 0x7f, 52)
#define set_cal(dt, cal)     set_value(dt, cal, 0x7, 59)
#define set_ver(dt, ver)     set_value(dt, ver, 0x3, 62)



/*
inline datetime_t fields_to_datetime(struct datetime_fields f)
{
	datetime_t dt = 0;
	if((f.year < 1582) || (f.year > 9774)){
		f.err = 1;
	}
	set_ms(dt,  f.ms);
	set_sec(dt, f.sec);
	set_min(dt, f.min);
	set_day(dt, f.day);
	set_hour(dt, f.hour);
	f.year -= 1582; //1st year of gregorian calendar
	set_year(dt, f.year);
	set_dow(dt, f.dow);
	f.month--; //for windows
	set_month(dt, f.month);
	set_tz( dt, abs((f.tz/15)-63) );
	set_cal(dt, f.cal);
	set_ver(dt, f.ver);

	return dt;
}


inline struct datetime_fields datetime_to_fields(datetime_t dt)
{
	static short utc_offset[] = {
	 945,  930,  915,  900,  885,  870,  855,  840,
	 825,  810,  795,  780,  765,  750,  735,  720,
	 705,  690,  675,  660,  645,  630,  615,  600,
	 585,  570,  555,  540,  525,  510,  495,  480,
	 465,  450,  435,  420,  405,  390,  375,  360,
	 345,  330,  315,  300,  285,  270,  255,  240,
	 225,  210,  195,  180,  165,  150,  135,  120,
	 105,   90,   75,   60,   45,   30,   15,    0,
	 -15,  -30,  -45,  -60,  -75,  -90, -105, -120,
	-135, -150, -165, -180, -195, -210, -225, -240,
	-255, -270, -285, -300, -315, -330, -345, -360,
	-375, -390, -405, -420, -435, -450, -465, -480,
	-495, -510, -525, -540, -555, -570, -585, -600,
	-615, -630, -645, -660, -675, -690, -705, -720,
	-735, -750, -765, -780, -795, -810, -825, -840,
	-855, -870, -885, -900, -915, -930, -945, -960
	};

	struct datetime_fields f;
	f.ms = get_ms(dt);
	f.sec = get_sec(dt);
	f.min = get_min(dt);
	f.day = get_day(dt);
	f.hour = get_hour(dt);
	f.year = get_year(dt)+1582;
	f.dow = get_dow(dt);
	f.month = get_month(dt);
	f.tz = utc_offset[get_tz(dt)];
	f.cal = get_cal(dt);
	f.ver = get_ver(dt);
	return f;
}
*/


